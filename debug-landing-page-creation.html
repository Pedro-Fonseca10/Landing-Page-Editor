<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - Cria√ß√£o de Landing Pages</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .btn { padding: 10px 15px; margin: 5px; border: none; border-radius: 3px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .log { background: #f8f9fa; padding: 10px; border-radius: 3px; margin: 5px 0; font-family: monospace; }
        .error { color: #dc3545; }
        .success { color: #28a745; }
        .warning { color: #ffc107; }
        .form-section { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .error-display { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 10px; border-radius: 3px; margin: 10px 0; }
        .data-display { background: #e9ecef; padding: 10px; border-radius: 3px; font-family: monospace; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Debug - Cria√ß√£o de Landing Pages</h1>
        
        <div class="section">
            <h3>Status do Sistema</h3>
            <button class="btn btn-primary" onclick="checkSystemStatus()">Verificar Status</button>
            <button class="btn btn-warning" onclick="createTestData()">Criar Dados de Teste</button>
            <button class="btn btn-danger" onclick="clearAllData()">Limpar Dados</button>
        </div>
        
        <div class="section">
            <h3>Formul√°rio de Cria√ß√£o de Cliente</h3>
            <div class="form-section">
                <input type="text" id="cliente-nome" placeholder="Nome do Cliente" style="width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 3px;">
                <input type="text" id="cliente-setor" placeholder="Setor (opcional)" style="width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 3px;">
                <button class="btn btn-success" onclick="createCliente()">Criar Cliente</button>
            </div>
        </div>
        
        <div class="section">
            <h3>Formul√°rio de Cria√ß√£o de Landing Page</h3>
            <div class="form-section">
                <input type="text" id="lp-titulo" placeholder="T√≠tulo da Landing Page" style="width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 3px;">
                <select id="lp-cliente" style="width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 3px;">
                    <option value="">Selecione um Cliente</option>
                </select>
                <select id="lp-template" style="width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 3px;">
                    <option value="saas">SaaS</option>
                    <option value="evento">Evento</option>
                    <option value="d2c">D2C</option>
                    <option value="portfolio">Portf√≥lio</option>
                </select>
                <button class="btn btn-success" onclick="createLandingPage()">Criar Landing Page</button>
            </div>
        </div>
        
        <div class="section">
            <h3>Dados Atuais</h3>
            <div id="current-data"></div>
        </div>
        
        <div class="section">
            <h3>Logs de Debug</h3>
            <div id="logs"></div>
        </div>
    </div>

    <script>
        const k = (name) => `plp:${name}`
        let errorMessage = null
        
        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs')
            const logEntry = document.createElement('div')
            logEntry.className = `log ${type}`
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`
            logsDiv.appendChild(logEntry)
            logsDiv.scrollTop = logsDiv.scrollHeight
        }
        
        // Fun√ß√£o uid melhorada
        function uid() {
            const timestamp = Date.now().toString(36)
            const random1 = Math.random().toString(36).slice(2, 10)
            const random2 = Math.random().toString(36).slice(2, 10)
            const performance = performance?.now?.()?.toString(36) || Math.random().toString(36).slice(2, 8)
            
            return `${timestamp}-${random1}-${random2}-${performance}`
        }
        
        // Fun√ß√£o para verificar se um ID j√° existe em uma lista
        function isUniqueId(id, existingIds) {
            return !existingIds.includes(id)
        }
        
        // Fun√ß√£o para gerar ID √∫nico garantindo que n√£o existe na lista
        function generateUniqueId(existingIds = []) {
            let attempts = 0
            const maxAttempts = 100
            
            while (attempts < maxAttempts) {
                const newId = uid()
                if (isUniqueId(newId, existingIds)) {
                    return newId
                }
                attempts++
            }
            
            // Fallback: usar timestamp + contador se todas as tentativas falharem
            return `fallback-${Date.now()}-${existingIds.length}`
        }
        
        function load(name, fallback = []) {
            try {
                const data = localStorage.getItem(k(name))
                const parsed = JSON.parse(data ?? "null") ?? fallback
                return parsed
            } catch (error) {
                log(`Erro ao carregar ${name}: ${error.message}`, 'error')
                return fallback
            }
        }
        
        function save(name, data) {
            try {
                localStorage.setItem(k(name), JSON.stringify(data))
                log(`‚úÖ Dados salvos em ${name}: ${data.length} itens`, 'success')
            } catch (error) {
                log(`‚ùå Erro ao salvar ${name}: ${error.message}`, 'error')
            }
        }
        
        function updateClienteSelect() {
            const select = document.getElementById('lp-cliente')
            const clientes = load("clientes", [])
            
            select.innerHTML = '<option value="">Selecione um Cliente</option>'
            clientes.forEach(cliente => {
                const option = document.createElement('option')
                option.value = cliente.id
                option.textContent = `${cliente.nome} (${cliente.setor || 'Sem setor'})`
                select.appendChild(option)
            })
            
            log(`Select de clientes atualizado: ${clientes.length} clientes dispon√≠veis`)
        }
        
        function showError(message) {
            errorMessage = message
            log(`‚ùå ERRO: ${message}`, 'error')
            displayCurrentData()
        }
        
        function checkSystemStatus() {
            log("=== VERIFICANDO STATUS DO SISTEMA ===", 'info')
            
            // Verificar localStorage
            try {
                const testKey = 'test-key'
                localStorage.setItem(testKey, 'test-value')
                const testValue = localStorage.getItem(testKey)
                localStorage.removeItem(testKey)
                
                if (testValue === 'test-value') {
                    log("‚úÖ localStorage funcionando corretamente", 'success')
                } else {
                    log("‚ùå localStorage com problema", 'error')
                }
            } catch (error) {
                log(`‚ùå Erro no localStorage: ${error.message}`, 'error')
            }
            
            // Verificar dados existentes
            const clientes = load("clientes", [])
            const lps = load("lps", [])
            
            log(`üìä Status dos dados:`)
            log(`   - Clientes: ${clientes.length}`)
            log(`   - Landing Pages: ${lps.length}`)
            
            // Verificar se h√° clientes
            if (clientes.length === 0) {
                log("‚ö†Ô∏è Nenhum cliente encontrado. Crie clientes primeiro.", 'warning')
            } else {
                log("‚úÖ Clientes dispon√≠veis para criar landing pages", 'success')
            }
            
            // Verificar se h√° landing pages
            if (lps.length === 0) {
                log("‚ö†Ô∏è Nenhuma landing page encontrada", 'warning')
            } else {
                log("‚úÖ Landing pages existentes encontradas", 'success')
            }
            
            // Verificar vincula√ß√£o
            if (lps.length > 0 && clientes.length > 0) {
                let lpsVinculadas = 0
                lps.forEach(lp => {
                    const cliente = clientes.find(c => c.id === lp.id_cliente)
                    if (cliente) lpsVinculadas++
                })
                
                log(`üîó Vincula√ß√£o: ${lpsVinculadas}/${lps.length} LPs vinculadas a clientes`)
            }
        }
        
        function createTestData() {
            log("=== CRIANDO DADOS DE TESTE ===", 'info')
            
            // Limpar dados existentes
            localStorage.removeItem(k("clientes"))
            localStorage.removeItem(k("lps"))
            
            // Criar 2 clientes de teste
            const clientes = [
                {
                    id: generateUniqueId([]),
                    nome: "Cliente Teste 1",
                    setor: "Tecnologia"
                },
                {
                    id: generateUniqueId([clientes[0]?.id].filter(Boolean)),
                    nome: "Cliente Teste 2",
                    setor: "Marketing"
                }
            ]
            
            save("clientes", clientes)
            log(`‚úÖ ${clientes.length} clientes de teste criados`)
            
            // Criar 2 landing pages de teste
            const lps = [
                {
                    id: generateUniqueId([]),
                    titulo: "LP Teste 1 - SaaS",
                    id_cliente: clientes[0].id,
                    id_template: "saas",
                    content: undefined
                },
                {
                    id: generateUniqueId([lps[0]?.id].filter(Boolean)),
                    titulo: "LP Teste 2 - Evento",
                    id_cliente: clientes[1].id,
                    id_template: "evento",
                    content: undefined
                }
            ]
            
            save("lps", lps)
            log(`‚úÖ ${lps.length} landing pages de teste criadas`)
            
            updateClienteSelect()
            displayCurrentData()
            
            log("üéâ Dados de teste criados com sucesso! Agora voc√™ pode testar a cria√ß√£o de novas landing pages.")
        }
        
        function createCliente() {
            const nome = document.getElementById('cliente-nome').value.trim()
            const setor = document.getElementById('cliente-setor').value.trim()
            
            if (!nome) {
                showError('Por favor, insira um nome para o cliente')
                return
            }
            
            log(`=== CRIANDO CLIENTE ===`)
            log(`Nome: ${nome}`)
            log(`Setor: ${setor || 'N√£o informado'}`)
            
            const clientes = load("clientes", [])
            
            // Verificar se j√° existe um cliente com o mesmo nome
            const existingCliente = clientes.find(c => 
                c.nome.toLowerCase() === nome.toLowerCase()
            )
            
            if (existingCliente) {
                showError(`J√° existe um cliente com o nome "${nome}"`)
                return
            }
            
            // Gerar ID √∫nico garantindo que n√£o existe na lista
            const existingIds = clientes.map(c => c.id)
            const newId = generateUniqueId(existingIds)
            
            log(`ID gerado: ${newId}`)
            
            const novoCliente = {
                id: newId,
                nome: nome,
                setor: setor
            }
            
            clientes.push(novoCliente)
            save("clientes", clientes)
            
            log(`‚úÖ Cliente criado com sucesso! Total de clientes: ${clientes.length}`, 'success')
            
            // Limpar formul√°rio
            document.getElementById('cliente-nome').value = ''
            document.getElementById('cliente-setor').value = ''
            
            // Atualizar select e display
            updateClienteSelect()
            displayCurrentData()
        }
        
        function createLandingPage() {
            const titulo = document.getElementById('lp-titulo').value.trim()
            const idCliente = document.getElementById('lp-cliente').value
            const template = document.getElementById('lp-template').value
            
            log(`=== TENTANDO CRIAR LANDING PAGE ===`)
            log(`T√≠tulo: "${titulo}"`)
            log(`Cliente ID: "${idCliente}"`)
            log(`Template: "${template}"`)
            
            if (!titulo) {
                showError('Por favor, insira um t√≠tulo para a landing page')
                return
            }
            
            if (!idCliente) {
                showError('Por favor, selecione um cliente')
                return
            }
            
            const lps = load("lps", [])
            const clientes = load("clientes", [])
            
            log(`Dados carregados:`)
            log(`   - LPs existentes: ${lps.length}`)
            log(`   - Clientes dispon√≠veis: ${clientes.length}`)
            
            // Verificar se o cliente existe
            const cliente = clientes.find(c => c.id === idCliente)
            if (!cliente) {
                showError(`Cliente com ID ${idCliente} n√£o encontrado`)
                return
            }
            
            log(`Cliente encontrado: ${cliente.nome}`)
            
            // Verificar se j√° existe uma LP com o mesmo t√≠tulo para o mesmo cliente
            const existingLp = lps.find(lp => 
                lp.titulo.toLowerCase() === titulo.toLowerCase() && 
                lp.id_cliente === idCliente
            )
            
            if (existingLp) {
                showError(`J√° existe uma landing page com o t√≠tulo "${titulo}" para este cliente`)
                return
            }
            
            // Gerar ID √∫nico garantindo que n√£o existe na lista
            const existingIds = lps.map(lp => lp.id)
            const newId = generateUniqueId(existingIds)
            
            log(`Novo ID gerado: ${newId}`)
            
            const novaLP = {
                id: newId,
                titulo: titulo,
                id_cliente: idCliente,
                id_template: template,
                content: undefined
            }
            
            log(`Objeto da nova LP criado:`, novaLP)
            
            try {
                lps.push(novaLP)
                log(`LP adicionada ao array local. Total: ${lps.length}`)
                
                save("lps", lps)
                log(`‚úÖ Landing Page salva no localStorage com sucesso!`)
                
                // Limpar formul√°rio
                document.getElementById('lp-titulo').value = ''
                document.getElementById('lp-cliente').value = ''
                
                // Atualizar display
                displayCurrentData()
                
            } catch (error) {
                log(`‚ùå Erro ao salvar landing page: ${error.message}`, 'error')
                showError(`Erro ao salvar: ${error.message}`)
            }
        }
        
        function clearAllData() {
            log("Limpando todos os dados...", 'warning')
            localStorage.removeItem(k("clientes"))
            localStorage.removeItem(k("lps"))
            log("‚úÖ Todos os dados foram limpos!", 'success')
            errorMessage = null
            displayCurrentData()
            updateClienteSelect()
        }
        
        function displayCurrentData() {
            const dataDiv = document.getElementById('current-data')
            const clientes = load("clientes", [])
            const lps = load("lps", [])
            
            let html = ''
            
            // Mostrar erro se houver
            if (errorMessage) {
                html += `<div class="error-display">‚ùå ${errorMessage}</div>`
            }
            
            html += '<h4>Clientes:</h4>'
            if (clientes.length === 0) {
                html += '<p>Nenhum cliente encontrado.</p>'
            } else {
                clientes.forEach((cliente, index) => {
                    const lpCount = lps.filter(lp => lp.id_cliente === cliente.id).length
                    html += `
                        <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 3px;">
                            <strong>Cliente ${index + 1}:</strong> ${cliente.nome}<br>
                            <strong>ID:</strong> ${cliente.id}<br>
                            <strong>Setor:</strong> ${cliente.setor || 'N√£o informado'}<br>
                            <strong>Landing Pages:</strong> ${lpCount}
                        </div>
                    `
                })
            }
            
            html += '<h4>Landing Pages:</h4>'
            if (lps.length === 0) {
                html += '<p>Nenhuma landing page encontrada.</p>'
            } else {
                lps.forEach((lp, index) => {
                    const cliente = clientes.find(c => c.id === lp.id_cliente)
                    html += `
                        <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 3px;">
                            <strong>LP ${index + 1}:</strong> ${lp.titulo}<br>
                            <strong>ID:</strong> ${lp.id}<br>
                            <strong>Template:</strong> ${lp.id_template}<br>
                            <strong>Cliente:</strong> ${cliente ? cliente.nome : `ID: ${lp.id_cliente} (N√ÉO ENCONTRADO)`}
                        </div>
                    `
                })
            }
            
            dataDiv.innerHTML = html
        }
        
        // Inicializa√ß√£o
        updateClienteSelect()
        displayCurrentData()
        log("Debug de Cria√ß√£o de Landing Pages iniciado.")
        log("1. Clique em 'Verificar Status' para diagnosticar o sistema")
        log("2. Clique em 'Criar Dados de Teste' para ter dados para testar")
        log("3. Tente criar clientes e landing pages")
    </script>
</body>
</html>
