<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Exclusão - Landing Pages</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
        button { margin: 5px; padding: 8px 16px; }
    </style>
</head>
<body>
    <h1>Debug Exclusão - Landing Pages</h1>
    
    <div class="debug-section">
        <h2>1. Dados atuais no localStorage</h2>
        <button onclick="displayCurrentData()">Atualizar Dados</button>
        <div id="current-data"></div>
    </div>
    
    <div class="debug-section">
        <h2>2. Análise de IDs</h2>
        <button onclick="analyzeIds()">Analisar IDs</button>
        <div id="id-analysis"></div>
    </div>
    
    <div class="debug-section">
        <h2>3. Teste de Exclusão Simples</h2>
        <button onclick="testSimpleDeletion()">Testar Exclusão Simples</button>
        <div id="simple-test"></div>
    </div>
    
    <div class="debug-section">
        <h2>4. Teste de Exclusão com ID Específico</h2>
        <input type="text" id="id-to-delete" placeholder="ID para excluir" />
        <button onclick="testSpecificDeletion()">Excluir ID Específico</button>
        <div id="specific-test"></div>
    </div>
    
    <div class="debug-section">
        <h2>5. Recriar Dados de Teste</h2>
        <button onclick="createTestData()">Criar Dados de Teste</button>
        <button onclick="clearData()">Limpar Todos os Dados</button>
        <div id="test-results"></div>
    </div>
    
    <div class="debug-section">
        <h2>6. Logs de Console</h2>
        <div id="console-logs"></div>
    </div>

    <script>
        const k = (name) => `plp:${name}`
        
        // Interceptar console.log para exibir na tela
        const originalLog = console.log
        const originalError = console.error
        const logContainer = document.getElementById('console-logs')
        
        function addLog(message, type = 'log') {
            const logEntry = document.createElement('div')
            logEntry.className = type
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`
            logContainer.appendChild(logEntry)
            logContainer.scrollTop = logContainer.scrollHeight
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args)
            addLog(args.join(' '), 'log')
        }
        
        console.error = function(...args) {
            originalError.apply(console, args)
            addLog(args.join(' '), 'error')
        }
        
        function load(name, fallback=[]) {
            try { 
                const data = localStorage.getItem(k(name))
                console.log(`Carregando ${name}:`, data)
                const parsed = JSON.parse(data ?? "null") ?? fallback
                console.log(`Dados parseados para ${name}:`, parsed)
                return parsed
            }
            catch (error) { 
                console.error(`Erro ao carregar ${name}:`, error)
                return fallback 
            }
        }
        
        function save(name, data) {
            console.log(`Salvando ${name}:`, data)
            localStorage.setItem(k(name), JSON.stringify(data))
        }
        
        function displayCurrentData() {
            const clientes = load("clientes", [])
            const lps = load("lps", [])
            
            document.getElementById('current-data').innerHTML = `
                <h3>Clientes (${clientes.length}):</h3>
                <pre>${JSON.stringify(clientes, null, 2)}</pre>
                
                <h3>Landing Pages (${lps.length}):</h3>
                <pre>${JSON.stringify(lps, null, 2)}</pre>
            `
        }
        
        function analyzeIds() {
            const lps = load("lps", [])
            const analysis = []
            
            lps.forEach((lp, index) => {
                const issues = []
                if (!lp.id) issues.push('ID vazio/undefined')
                if (lp.id === '') issues.push('ID string vazio')
                if (typeof lp.id !== 'string') issues.push(`ID não é string (${typeof lp.id})`)
                if (lp.id && lp.id.length < 3) issues.push('ID muito curto')
                
                analysis.push({
                    index,
                    id: lp.id,
                    titulo: lp.titulo,
                    id_cliente: lp.id_cliente,
                    issues: issues.length > 0 ? issues : ['OK']
                })
            })
            
            document.getElementById('id-analysis').innerHTML = `
                <h3>Análise de IDs:</h3>
                <pre>${JSON.stringify(analysis, null, 2)}</pre>
            `
        }
        
        function testSimpleDeletion() {
            const lps = load("lps", [])
            if (lps.length === 0) {
                document.getElementById('simple-test').innerHTML = '<p class="error">Nenhuma landing page para testar!</p>'
                return
            }
            
            const idToDelete = lps[0].id
            console.log('=== TESTE DE EXCLUSÃO SIMPLES ===')
            console.log('ID a ser excluído:', idToDelete)
            console.log('Lista antes:', lps)
            
            // Simular a lógica exata da aplicação
            const next = lps.filter(lp => lp.id !== idToDelete)
            console.log('Lista após filtro:', next)
            console.log('Total removido:', lps.length - next.length)
            
            if (lps.length - next.length !== 1) {
                console.error('PROBLEMA: Mais de uma landing page foi removida!')
                document.getElementById('simple-test').innerHTML = `
                    <p class="error">PROBLEMA DETECTADO!</p>
                    <p>Total antes: ${lps.length}</p>
                    <p>Total depois: ${next.length}</p>
                    <p>Total removido: ${lps.length - next.length}</p>
                `
            } else {
                save("lps", next)
                document.getElementById('simple-test').innerHTML = `
                    <p class="success">Teste passou!</p>
                    <p>Landing page removida: ${idToDelete}</p>
                `
                displayCurrentData()
            }
        }
        
        function testSpecificDeletion() {
            const idToDelete = document.getElementById('id-to-delete').value.trim()
            if (!idToDelete) {
                document.getElementById('specific-test').innerHTML = '<p class="error">Digite um ID para excluir</p>'
                return
            }
            
            const lps = load("lps", [])
            console.log('=== TESTE DE EXCLUSÃO ESPECÍFICA ===')
            console.log('ID a ser excluído:', idToDelete)
            console.log('Lista antes:', lps)
            
            const landingPageToDelete = lps.find(lp => lp.id === idToDelete)
            if (!landingPageToDelete) {
                document.getElementById('specific-test').innerHTML = `
                    <p class="warning">Landing page com ID "${idToDelete}" não encontrada</p>
                    <p>IDs disponíveis: ${lps.map(lp => lp.id).join(', ')}</p>
                `
                return
            }
            
            const next = lps.filter(lp => lp.id !== idToDelete)
            console.log('Landing page encontrada:', landingPageToDelete)
            console.log('Lista após filtro:', next)
            console.log('Total removido:', lps.length - next.length)
            
            save("lps", next)
            document.getElementById('specific-test').innerHTML = `
                <p class="success">Landing page removida com sucesso!</p>
                <p>ID: ${idToDelete}</p>
                <p>Título: ${landingPageToDelete.titulo}</p>
            `
            displayCurrentData()
        }
        
        function createTestData() {
            // Criar clientes de teste
            const clientes = [
                { id: "cliente1", nome: "Cliente A", email: "clientea@teste.com" },
                { id: "cliente2", nome: "Cliente B", email: "clienteb@teste.com" },
                { id: "cliente3", nome: "Cliente C", email: "clientec@teste.com" }
            ]
            
            // Criar landing pages de teste com IDs únicos
            const lps = [
                { id: "lp1", titulo: "LP 1 - Cliente A", id_cliente: "cliente1", id_template: "saas" },
                { id: "lp2", titulo: "LP 2 - Cliente A", id_cliente: "cliente1", id_template: "evento" },
                { id: "lp3", titulo: "LP 3 - Cliente B", id_cliente: "cliente2", id_template: "d2c" },
                { id: "lp4", titulo: "LP 4 - Cliente C", id_cliente: "cliente3", id_template: "portfolio" }
            ]
            
            save("clientes", clientes)
            save("lps", lps)
            
            displayCurrentData()
            document.getElementById('test-results').innerHTML = '<p class="success">Dados de teste criados!</p>'
        }
        
        function clearData() {
            localStorage.removeItem(k("clientes"))
            localStorage.removeItem(k("lps"))
            displayCurrentData()
            document.getElementById('test-results').innerHTML = '<p class="success">Dados limpos!</p>'
        }
        
        // Exibir dados iniciais
        displayCurrentData()
        console.log('Debug iniciado. Use os botões para testar a funcionalidade.')
    </script>
</body>
</html>
